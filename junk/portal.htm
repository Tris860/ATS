<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Command Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f4f8;
      min-height: 100vh;
    }
  </style>
</head>
<body class="flex items-center justify-center p-4">
  <div class="max-w-xl w-full bg-white shadow-2xl rounded-xl p-8 space-y-6">
    <h1 class="text-3xl font-extrabold text-gray-900 text-center">Wemos IoT Command</h1>
    <p class="text-center text-sm text-gray-600">
      Client connected to Server A (via WebSocket) which forwards commands to Server B (via HTTP).
    </p>

    <!-- Connection Status Indicator -->
    <div id="status" class="flex items-center justify-center p-3 rounded-lg shadow-inner bg-gray-100">
      <div id="status-dot" class="w-3 h-3 rounded-full mr-2 bg-gray-400"></div>
      <span id="status-text" class="text-sm font-medium text-gray-600">Connecting...</span>
    </div>

    <!-- Command Buttons -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4">
      <button onclick="sendCommand('HARD_ON')" class="command-btn bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-200 transform hover:scale-[1.02]">HARD ON</button>
      <button onclick="sendCommand('HARD_OFF')" class="command-btn bg-rose-500 hover:bg-rose-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-200 transform hover:scale-[1.02]">HARD OFF</button>
      <button onclick="sendCommand('AUTO_ON')" class="command-btn bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-200 transform hover:scale-[1.02]">AUTO ON</button>
    </div>

    <!-- Log Area -->
    <div class="pt-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-2">System Log</h2>
      <div id="log" class="h-48 overflow-y-scroll bg-gray-800 text-green-400 p-4 rounded-lg text-xs font-mono">
        Waiting for WebSocket connection...
      </div>
    </div>

    <!-- Special TIME MATCHED Banner -->
    <div id="timeMatchedBanner" class="hidden mt-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg text-center font-bold">
      âœ… TIME MATCHED detected!
    </div>
  </div>

<script>
  // Replace with your actual Server A WebSocket URL, including ?email=...
  const USER_EMAIL = "shimo@gmail.com"; // dynamically set this per logged-in user
  const WS_URL = `wss://webserver-ft8c.onrender.com/ws/browser?email=${encodeURIComponent(USER_EMAIL)}`;
  let socket;

  const logElement = document.getElementById('log');
  const statusDot = document.getElementById('status-dot');
  const statusText = document.getElementById('status-text');
  const commandButtons = document.querySelectorAll('.command-btn');
  const timeMatchedBanner = document.getElementById('timeMatchedBanner');

  function updateLog(message, type = 'info') {
    const time = new Date().toLocaleTimeString();
    let color = 'text-green-400';
    if (type === 'error') color = 'text-red-400';
    if (type === 'warn') color = 'text-yellow-400';
    if (type === 'system') color = 'text-gray-400';
    if (type === 'matched') color = 'text-blue-400 font-bold';

    logElement.innerHTML += `<div class="${color}">[${time}] ${message}</div>`;
    logElement.scrollTop = logElement.scrollHeight;
  }

  function connectWebSocket() {
    if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
      return;
    }

    updateLog(`Attempting to connect to Server A at ${WS_URL}...`, 'system');
    socket = new WebSocket(WS_URL);

    socket.onopen = function() {
      statusDot.classList.remove('bg-gray-400', 'bg-red-500', 'bg-yellow-500');
      statusDot.classList.add('bg-green-500');
      statusText.textContent = 'Connected to Server A';
      updateLog('WebSocket connection established.', 'info');
      commandButtons.forEach(btn => btn.disabled = false);
    };

    socket.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);

        switch (data.type) {
          case "device_binding":
            updateLog(`Bound to device: ${data.deviceName}`, 'system');
            break;

          case "device_status":
            updateLog(`Device ${data.deviceName} â†’ ${data.status}`, data.status === "CONNECTED" ? 'info' : 'error');
            if (data.status === "CONNECTED") {
              statusDot.classList.add('bg-green-500');
              statusText.textContent = `Device ${data.deviceName} connected`;
            } else {
              statusDot.classList.add('bg-red-500');
              statusText.textContent = `Device ${data.deviceName} disconnected`;
            }
            break;

          case "auto_on_trigger":
            updateLog(`ðŸš€ AUTO_ON triggered for ${data.deviceName}: ${data.message}`, 'matched');
            timeMatchedBanner.classList.remove('hidden');
            break;

          case "ack":
            updateLog(`âœ… Command acknowledged by ${data.deviceId}: ${data.response}`, 'info');
            break;

          case "error":
            updateLog(`âŒ Error: ${data.message}`, 'error');
            break;

          default:
            updateLog(`Server A: ${event.data}`, 'info');
        }
      } catch (err) {
        // fallback if message is plain text
        if (event.data.includes("TIME_MATCHED")) {
          updateLog(`ðŸš€ ${event.data}`, 'matched');
          timeMatchedBanner.classList.remove('hidden');
        } else {
          updateLog(`Server A Response: ${event.data}`, 'info');
        }
      }
    };

    socket.onclose = function(event) {
      statusDot.classList.remove('bg-green-500');
      statusDot.classList.add('bg-red-500');
      statusText.textContent = 'Disconnected';
      updateLog(`WebSocket closed: ${event.code} ${event.reason}. Retrying in 5s...`, 'error');
      commandButtons.forEach(btn => btn.disabled = true);
      setTimeout(connectWebSocket, 5000);
    };

    socket.onerror = function(error) {
      statusText.textContent = 'Error';
      updateLog(`WebSocket Error: ${error.message || 'Check Server A Status.'}`, 'error');
    };
  }

  function sendCommand(command) {
    if (socket.readyState === WebSocket.OPEN) {
      updateLog(`Sending command: ${command} to Server A...`, 'warn');
      socket.send(JSON.stringify({ type: "command", payload: { action: command } }));
    } else {
      updateLog('Cannot send command. WebSocket is not open.', 'error');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    connectWebSocket();
    commandButtons.forEach(btn => btn.disabled = true);
  });
</script>

</body>
</html>
