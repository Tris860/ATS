<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Command Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; min-height: 100vh; }
  </style>
</head>
<body class="flex items-center justify-center p-4">
  <div class="max-w-xl w-full bg-white shadow-2xl rounded-xl p-8 space-y-6">
    <h1 class="text-3xl font-extrabold text-gray-900 text-center">Wemos IoT Command</h1>
    <p class="text-center text-sm text-gray-600">
      Connected to Unified Server at <code>combined-server-1fyr.onrender.com</code>
    </p>

    <!-- Connection Status Indicator -->
    <div id="status" class="flex items-center justify-center p-3 rounded-lg shadow-inner bg-gray-100">
      <div id="status-dot" class="w-3 h-3 rounded-full mr-2 bg-gray-400"></div>
      <span id="status-text" class="text-sm font-medium text-gray-600">Connecting...</span>
    </div>

    <!-- Command Buttons -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4">
      <button onclick="sendCommand('HARD_ON')" class="command-btn bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg">HARD ON</button>
      <button onclick="sendCommand('HARD_OFF')" class="command-btn bg-rose-500 hover:bg-rose-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg">HARD OFF</button>
      <button onclick="sendCommand('AUTO_ON')" class="command-btn bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg">AUTO ON</button>
    </div>

    <!-- Log Area -->
    <div class="pt-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-2">System Log</h2>
      <div id="log" class="h-48 overflow-y-scroll bg-gray-800 text-green-400 p-4 rounded-lg text-xs font-mono">
        Waiting for WebSocket connection...
      </div>
    </div>
  </div>

<script>
  const WS_DEVICE_URL = "wss://combined-server-1fyr.onrender.com/ws/device?deviceId=1";
  const WS_BROWSER_URL = "wss://combined-server-1fyr.onrender.com/ws/browser?email=shimo@gmail.com"; // owner email for notifications
  const CMD_URL = "https://combined-server-1fyr.onrender.com/command";
  const DEVICE_NAME = "wemos_user";

  let deviceSocket, browserSocket;
  const logElement = document.getElementById('log');
  const statusDot = document.getElementById('status-dot');
  const statusText = document.getElementById('status-text');

  function updateLog(message, type = 'info') {
    const time = new Date().toLocaleTimeString();
    let color = 'text-green-400';
    if (type === 'error') color = 'text-red-400';
    if (type === 'warn') color = 'text-yellow-400';
    if (type === 'system') color = 'text-gray-400';
    logElement.innerHTML += `<div class="${color}">[${time}] ${message}</div>`;
    logElement.scrollTop = logElement.scrollHeight;
  }

  function connectDeviceWS() {
    updateLog(`Connecting to ${WS_DEVICE_URL}...`, 'system');
    deviceSocket = new WebSocket(WS_DEVICE_URL);

    deviceSocket.onopen = () => {
      statusDot.classList.replace('bg-gray-400','bg-green-500');
      statusText.textContent = 'Connected';
      updateLog('Device WebSocket established.', 'info');
      deviceSocket.send(JSON.stringify({ type:"auth", username:"wemos_user", password:"wemos_pass" }));
    };

    deviceSocket.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.type === "pong") updateLog("Received PONG", 'system');
        else if (data.type === "auth_failed") updateLog("Auth failed: " + data.reason, 'error');
        else if (data.type === "command") updateLog(`Command received: ${data.payload.action}`, 'warn');
        else if (data.type === "status") updateLog(`Device status: ${JSON.stringify(data)}`, 'info');
        else updateLog("Server: " + event.data, 'system');
      } catch { updateLog("Raw: " + event.data, 'system'); }
    };

    deviceSocket.onclose = () => {
      statusDot.classList.replace('bg-green-500','bg-red-500');
      statusText.textContent = 'Disconnected';
      updateLog("Device WebSocket closed. Retrying in 5s...", 'error');
      setTimeout(connectDeviceWS, 5000);
    };
  }

  function connectBrowserWS() {
    updateLog(`Connecting to ${WS_BROWSER_URL}...`, 'system');
    browserSocket = new WebSocket(WS_BROWSER_URL);

    browserSocket.onopen = () => updateLog('Browser WebSocket established.', 'info');
    browserSocket.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.type === "auto_on_trigger") {
          updateLog(`ðŸ”” AUTO_ON triggered for ${data.deviceName}: ${data.message}`, 'warn');
        } else if (data.type === "device_status") {
          updateLog(`Device ${data.deviceName} status: ${data.status}`, 'info');
        } else {
          updateLog("Browser WS: " + event.data, 'system');
        }
      } catch { updateLog("Browser raw: " + event.data, 'system'); }
    };
    browserSocket.onclose = () => updateLog("Browser WebSocket closed.", 'error');
  }

  async function sendCommand(command) {
    updateLog(`Sending command: ${command}`, 'warn');
    try {
      const response = await fetch(CMD_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ command: command, deviceName: DEVICE_NAME })
      });
      const data = await response.json();
      if (data.status === "ok") updateLog(`âœ… ${data.message}`, 'info');
      else updateLog(`âŒ Error: ${data.message}`, 'error');
    } catch (err) {
      updateLog("Network error: " + err, 'error');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    connectDeviceWS();
    connectBrowserWS();
  });
</script>
</body>
</html>
